<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Meta tagi dla PWA -->
<meta name="theme-color" content="#5497c4" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ewidencja Aut">
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon.png" type="image/png">
<link rel="apple-touch-icon" href="icon-512.png">

<title>Ewidencja przebiegu samochod√≥w s≈Çu≈ºbowych</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: Arial, sans-serif; 
    margin: 0;
    padding: 10px;
    background-color: #f0f0f0;
  }
  h1 { 
    text-align: center; 
    font-size: 1.5em;
    margin: 10px 0;
  }
  h2 {
    font-size: 1.2em;
    margin: 15px 0 10px 0;
  }
  select, input { 
    margin: 5px 0;
    padding: 10px;
    width: 100%;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  button {
    background-color: #5497c4;
    color: white;
    border: none;
    padding: 12px 16px;
    cursor: pointer;
    margin: 5px 2px;
    border-radius: 4px;
    transition: background-color 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    font-size: 14px;
    min-height: 44px;
  }
  button:hover {
    background-color: #006fb9;
  }
  button:active {
    transform: scale(0.98);
  }
  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 15px;
    font-size: 14px;
  }
  th, td { 
    border: 1px solid #ccc; 
    padding: 8px 4px; 
    text-align: center;
    word-wrap: break-word;
  }
  th {
    background-color: #5497c4;
    color: white;
    position: sticky;
    top: 0;
  }
  .container { 
    max-width: 1000px; 
    margin: auto;
    background-color: #c2e1ff;
    padding: 15px;
    border-radius: 5px;
  }
  
  @media (max-width: 600px) {
    body { padding: 5px; }
    .container { padding: 10px; }
    h1 { font-size: 1.3em; }
    h2 { font-size: 1.1em; }
    table { font-size: 12px; }
    th, td { padding: 6px 2px; }
    button { 
      padding: 10px 12px;
      font-size: 13px;
      width: 100%;
      margin: 3px 0;
    }
  }
  
  #installPrompt {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #5497c4;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    z-index: 2000;
    display: none;
    max-width: 90%;
    text-align: center;
  }
  #installPrompt button {
    margin: 5px;
  }
  
  .status-indicator {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    margin-left: 10px;
  }
  .status-online {
    background-color: #4CAF50;
    color: white;
  }
  .status-offline {
    background-color: #ff9800;
    color: white;
  }
  .sync-status {
    text-align: center;
    padding: 10px;
    margin: 10px 0;
    border-radius: 5px;
    font-size: 14px;
  }
  .sync-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  .sync-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  .sync-info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }
</style>
</head>
<body>

<div id="installPrompt">
  <p><strong>Zainstaluj aplikacjƒô na swoim urzƒÖdzeniu!</strong></p>
  <button id="installButton">Zainstaluj</button>
  <button id="dismissButton" style="background-color: #999;">P√≥≈∫niej</button>
</div>

<div class="container">
<h1>
  Ewidencja przebiegu samochod√≥w s≈Çu≈ºbowych
  <span id="statusIndicator" class="status-indicator status-offline">Tryb lokalny</span>
</h1>

<div id="syncStatus" class="sync-status sync-info" style="display:none;"></div>

<h2>Dodaj nowy wpis</h2>
<form id="tripForm">
  <label for="employee">Nazwisko pracownika:</label>
  <input type="text" id="employee" placeholder="Wpisz nazwisko" required/><br/>

  <label for="vehicle">Samoch√≥d:</label>
  <select id="vehicle" required>
    <option value="Skoda Octavia RZ1">Skoda Octavia RZ1</option>
    <option value="Skoda Octavia RZ2">Skoda Octavia RZ2</option>
    <option value="Skoda Octavia RZ3">Skoda Octavia RZ3</option>
    <option value="Skoda Superb RZ4">Skoda Superb RZ4</option>
  </select><br/>

  <label for="date">Data:</label>
  <input type="date" id="date" required/><br/>

  <label for="start">Przed wyjazdem (km):</label>
  <input type="number" id="start" required/><br/>

  <label for="end">Po powrocie (km):</label>
  <input type="number" id="end" required/><br/>

  <button type="submit">Zapisz wpis</button>
</form>

<h2>Opcje</h2>
<button onclick="showSummary()">Wy≈õwietl podsumowania</button>
<button onclick="exportCSV()">Eksport do CSV</button>
<button onclick="showArchiveDialog()">Archiwum</button>
<button onclick="syncWithSheets()" id="syncButton">üîÑ Synchronizuj z Google Sheets</button>
<button onclick="clearEntries()">Usu≈Ñ wszystkie wpisy</button>

<div id="archiveDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:1000; max-width:500px;">
  <h3>Archiwizacja danych</h3>
  <p>Wybierz zakres dat do przeniesienia do archiwum:</p>
  <label>Data od:</label>
  <input type="date" id="archiveFrom" style="display:block; width:100%; margin-bottom:10px;"/><br/>
  <label>Data do:</label>
  <input type="date" id="archiveTo" style="display:block; width:100%; margin-bottom:20px;"/><br/>
  <button onclick="archiveEntries()">Przenie≈õ do archiwum</button>
  <button onclick="showArchive()">Poka≈º archiwum</button>
  <button onclick="closeArchiveDialog()">Anuluj</button>
</div>

<div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="closeArchiveDialog()"></div>

<div id="archiveView" style="display:none;">
  <h2>Archiwum <button onclick="hideArchive()">Zamknij archiwum</button></h2>
  <div id="archiveEntries"></div>
  <button onclick="restoreFromArchive()">Przywr√≥ƒá wszystkie z archiwum</button>
  <button onclick="clearArchive()">Usu≈Ñ ca≈Çe archiwum</button>
</div>

<div id="summary"></div>

<h2>Historia wpis√≥w</h2>
<div id="entries"></div>
</div>

<script>
// ====== KONFIGURACJA GOOGLE SHEETS ======
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyt-wKHaNXLAutcYBVOxrSpPEH7fwfRXXSIjpzgfKerc95Gd1bK2BlVD7aFv9vJtkvK/exec';

let isOnline = false;
let syncInProgress = false;

function isSheetsConfigured() {
  return GOOGLE_SCRIPT_URL !== 'https://script.google.com/macros/s/AKfycbyt-wKHaNXLAutcYBVOxrSpPEH7fwfRXXSIjpzgfKerc95Gd1bK2BlVD7aFv9vJtkvK/exec';
}

function getData() {
  const data = localStorage.getItem('carLogs');
  return data ? JSON.parse(data) : {};
}

function saveData(data) {
  localStorage.setItem('carLogs', JSON.stringify(data));
}

function getArchiveData() {
  const data = localStorage.getItem('carLogsArchive');
  return data ? JSON.parse(data) : {};
}

function saveArchiveData(data) {
  localStorage.setItem('carLogsArchive', JSON.stringify(data));
}

function updateConnectionStatus() {
  const indicator = document.getElementById('statusIndicator');
  if (isSheetsConfigured() && isOnline) {
    indicator.textContent = '‚òÅÔ∏è Online (Google Sheets)';
    indicator.className = 'status-indicator status-online';
  } else {
    indicator.textContent = 'üíæ Tryb lokalny';
    indicator.className = 'status-indicator status-offline';
  }
}

function showSyncStatus(message, type = 'info') {
  const syncStatus = document.getElementById('syncStatus');
  syncStatus.textContent = message;
  syncStatus.className = `sync-status sync-${type}`;
  syncStatus.style.display = 'block';
  
  setTimeout(() => {
    syncStatus.style.display = 'none';
  }, 5000);
}

async function syncWithSheets() {
  if (!isSheetsConfigured()) {
    alert('Google Sheets nie jest skonfigurowany!\n\nSprawd≈∫ instrukcjƒô konfiguracji Google Sheets i wklej URL swojego skryptu w kodzie aplikacji.');
    return;
  }
  
  if (syncInProgress) {
    showSyncStatus('Synchronizacja ju≈º trwa...', 'info');
    return;
  }
  
  syncInProgress = true;
  const syncButton = document.getElementById('syncButton');
  syncButton.disabled = true;
  syncButton.textContent = 'üîÑ Synchronizacja...';
  
  try {
    showSyncStatus('Synchronizacja z Google Sheets...', 'info');
    
    const localData = getData();
    
    for (const vehicle in localData) {
      for (const entry of localData[vehicle]) {
        await sendToSheets('addEntry', { entry: {...entry, vehicle} });
      }
    }
    
    showSyncStatus('‚úÖ Synchronizacja zako≈Ñczona pomy≈õlnie!', 'success');
    isOnline = true;
    updateConnectionStatus();
  } catch (error) {
    console.error('B≈ÇƒÖd synchronizacji:', error);
    showSyncStatus('‚ùå B≈ÇƒÖd synchronizacji: ' + error.message, 'error');
  } finally {
    syncInProgress = false;
    syncButton.disabled = false;
    syncButton.textContent = 'üîÑ Synchronizuj z Google Sheets';
  }
}

async function sendToSheets(action, data) {
  if (!isSheetsConfigured()) {
    return null;
  }
  
  try {
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ action, ...data })
    });
    
    isOnline = true;
    updateConnectionStatus();
    return { success: true };
  } catch (error) {
    console.error('B≈ÇƒÖd wysy≈Çania do Sheets:', error);
    isOnline = false;
    updateConnectionStatus();
    throw error;
  }
}

// Dodanie nowego wpisu
document.getElementById('tripForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const employee = document.getElementById('employee').value.trim();
  const vehicle = document.getElementById('vehicle').value;
  const date = document.getElementById('date').value;
  const startKm = parseInt(document.getElementById('start').value);
  const endKm = parseInt(document.getElementById('end').value);

  if (endKm < startKm) {
    alert('Koniec odczytu musi byƒá wiƒôkszy od poczƒÖtku!');
    return;
  }

  if (!employee) {
    alert('Proszƒô wpisaƒá nazwisko pracownika!');
    return;
  }

  const data = getData();
  if (!data[vehicle]) {
    data[vehicle] = [];
  }

  const entry = {
    id: Date.now(),
    employee: employee,
    date: date,
    start: startKm,
    end: endKm,
    przebieg: endKm - startKm
  };

  data[vehicle].push(entry);
  saveData(data);
  
  // Spr√≥buj zapisaƒá do Google Sheets
  if (isSheetsConfigured()) {
    try {
      await sendToSheets('addEntry', { entry: {...entry, vehicle} });
      showSyncStatus('‚úÖ Wpis zapisany i zsynchronizowany z Google Sheets', 'success');
    } catch (error) {
      showSyncStatus('üíæ Wpis zapisany lokalnie (brak po≈ÇƒÖczenia z Google Sheets)', 'info');
    }
  } else {
    alert('Wpis zapisany lokalnie!');
  }
  
  document.getElementById('tripForm').reset();
  displayEntries();
});

// Wy≈õwietlanie wpis√≥w
function displayEntries() {
  const data = getData();
  const container = document.getElementById('entries');
  container.innerHTML = '';

  for (const vehicle in data) {
    const title = document.createElement('h3');
    title.textContent = vehicle;
    container.appendChild(title);

    const table = document.createElement('table');
    const header = document.createElement('tr');
    header.innerHTML = '<th>Pracownik</th><th>Data</th><th>Start (km)</th><th>Koniec (km)</th><th>Przebieg (km)</th><th>Akcje</th>';
    table.appendChild(header);

    data[vehicle].forEach((entry) => {
      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${entry.employee || '-'}</td>
        <td>${entry.date}</td>
        <td>${entry.start}</td>
        <td>${entry.end}</td>
        <td>${entry.przebieg}</td>
        <td>
          <button onclick="editEntry('${vehicle}', ${entry.id})">Edytuj</button>
          <button onclick="deleteEntry('${vehicle}', ${entry.id})">Usu≈Ñ</button>
        </td>
      `;
      row.setAttribute('data-vehicle', vehicle);
      row.setAttribute('data-id', entry.id);
      table.appendChild(row);
    });

    container.appendChild(table);
  }
}

// Edycja wpisu
function editEntry(vehicle, id) {
  const data = getData();
  const entryIndex = data[vehicle].findIndex(e => e.id === id);
  if (entryIndex === -1) return;

  const entry = data[vehicle][entryIndex];

  document.getElementById('employee').value = entry.employee || '';
  document.getElementById('vehicle').value = vehicle;
  document.getElementById('date').value = entry.date;
  document.getElementById('start').value = entry.start;
  document.getElementById('end').value = entry.end;

  data[vehicle].splice(entryIndex, 1);
  saveData(data);
  displayEntries();
  
  document.getElementById('tripForm').scrollIntoView({ behavior: 'smooth' });
}

// Usuwanie wpisu
async function deleteEntry(vehicle, id) {
  if (!confirm('Czy na pewno chcesz usunƒÖƒá ten wpis?')) {
    return;
  }
  
  const data = getData();
  data[vehicle] = data[vehicle].filter(e => e.id !== id);
  saveData(data);
  
  if (isSheetsConfigured()) {
    try {
      await sendToSheets('deleteEntry', { id: id });
    } catch (error) {
      console.error('B≈ÇƒÖd usuwania z Sheets:', error);
    }
  }
  
  displayEntries();
}

// Podsumowania miesiƒôczne
function showSummary() {
  const data = getData();
  const summaryDiv = document.getElementById('summary');
  summaryDiv.innerHTML = '';

  const monthTotals = {};

  for (const vehicle in data) {
    data[vehicle].forEach(entry => {
      const month = entry.date.slice(0, 7);
      const employee = entry.employee || 'Nieznany';
      
      if (!monthTotals[month]) {
        monthTotals[month] = {};
      }
      
      const key = `${vehicle} (${employee})`;
      
      if (!monthTotals[month][key]) {
        monthTotals[month][key] = 0;
      }
      monthTotals[month][key] += entry.przebieg;
    });
  }

  for (const month in monthTotals) {
    const h3 = document.createElement('h3');
    h3.textContent = `MiesiƒÖc: ${month}`;
    summaryDiv.appendChild(h3);
    const ul = document.createElement('ul');
    for (const key in monthTotals[month]) {
      const li = document.createElement('li');
      li.textContent = `${key}: ${monthTotals[month][key]} km`;
      ul.appendChild(li);
    }
    summaryDiv.appendChild(ul);
  }
}

// Eksport do CSV
function exportCSV() {
  const data = getData();
  let csvContent = 'Pracownik,Samoch√≥d,Data,Start (km),Koniec (km),Przebieg (km)\n';

  for (const vehicle in data) {
    data[vehicle].forEach(entry => {
      const employee = entry.employee || '-';
      csvContent += `"${employee}","${vehicle}","${entry.date}",${entry.start},${entry.end},${entry.przebieg}\n`;
    });
  }

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'przebiegi_samochody.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// Czyszczenie wszystkich wpis√≥w
function clearEntries() {
  if (confirm('Czy na pewno chcesz usunƒÖƒá wszystkie wpisy?')) {
    localStorage.removeItem('carLogs');
    displayEntries();
  }
}

// Dialog archiwizacji
function showArchiveDialog() {
  document.getElementById('archiveDialog').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
}

function closeArchiveDialog() {
  document.getElementById('archiveDialog').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}

// Archiwizacja wpis√≥w
async function archiveEntries() {
  const dateFrom = document.getElementById('archiveFrom').value;
  const dateTo = document.getElementById('archiveTo').value;

  if (!dateFrom || !dateTo) {
    alert('Proszƒô wybraƒá zakres dat!');
    return;
  }

  if (dateFrom > dateTo) {
    alert('Data "od" nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º data "do"!');
    return;
  }

  const data = getData();
  const archiveData = getArchiveData();
  let movedCount = 0;

  for (const vehicle in data) {
    if (!archiveData[vehicle]) {
      archiveData[vehicle] = [];
    }

    const toArchive = data[vehicle].filter(entry => 
      entry.date >= dateFrom && entry.date <= dateTo
    );
    
    data[vehicle] = data[vehicle].filter(entry => 
      entry.date < dateFrom || entry.date > dateTo
    );

    archiveData[vehicle].push(...toArchive);
    movedCount += toArchive.length;

    if (data[vehicle].length === 0) {
      delete data[vehicle];
    }
  }

  saveData(data);
  saveArchiveData(archiveData);
  
  if (isSheetsConfigured()) {
    try {
      await sendToSheets('archiveEntries', { dateFrom: dateFrom, dateTo: dateTo });
    } catch (error) {
      console.error('B≈ÇƒÖd archiwizacji w Sheets:', error);
    }
  }
  
  displayEntries();
  closeArchiveDialog();
  
  alert(`Przeniesiono ${movedCount} wpis√≥w do archiwum.`);
}

// Pokazywanie archiwum
function showArchive() {
  const archiveData = getArchiveData();
  const container = document.getElementById('archiveEntries');
  container.innerHTML = '';

  let hasEntries = false;
  for (const vehicle in archiveData) {
    if (archiveData[vehicle].length > 0) {
      hasEntries = true;
      const title = document.createElement('h3');
      title.textContent = vehicle + ' (Archiwum)';
      container.appendChild(title);

      const table = document.createElement('table');
      const header = document.createElement('tr');
      header.innerHTML = '<th>Pracownik</th><th>Data</th><th>Start (km)</th><th>Koniec (km)</th><th>Przebieg (km)</th>';
      table.appendChild(header);

      archiveData[vehicle].forEach((entry) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${entry.employee || '-'}</td>
          <td>${entry.date}</td>
          <td>${entry.start}</td>
          <td>${entry.end}</td>
          <td>${entry.przebieg}</td>
        `;
        table.appendChild(row);
      });

      container.appendChild(table);
    }
  }

  if (!hasEntries) {
    container.innerHTML = '<p>Archiwum jest puste.</p>';
  }

  document.getElementById('archiveView').style.display = 'block';
  closeArchiveDialog();
}

function hideArchive() {
  document.getElementById('archiveView').style.display = 'none';
}

// Przywracanie z archiwum
async function restoreFromArchive() {
  if (!confirm('Czy na pewno chcesz przywr√≥ciƒá wszystkie wpisy z archiwum?')) {
    return;
  }

  const data = getData();
  const archiveData = getArchiveData();

  for (const vehicle in archiveData) {
    if (!data[vehicle]) {
      data[vehicle] = [];
    }
    data[vehicle].push(...archiveData[vehicle]);
  }

  saveData(data);
  localStorage.removeItem('carLogsArchive');
  
  if (isSheetsConfigured()) {
    try {
      await sendToSheets('restoreArchive', {});
    } catch (error) {
      console.error('B≈ÇƒÖd przywracania w Sheets:', error);
    }
  }
  
  displayEntries();
  hideArchive();
  alert('Wszystkie wpisy zosta≈Çy przywr√≥cone z archiwum.');
}

// Czyszczenie archiwum
function clearArchive() {
  if (confirm('Czy na pewno chcesz usunƒÖƒá ca≈Çe archiwum? Ta operacja jest nieodwracalna!')) {
    localStorage.removeItem('carLogsArchive');
    hideArchive();
    alert('Archiwum zosta≈Ço usuniƒôte.');
  }
}

// Automatyczne wy≈õwietlenie wpis√≥w
window.onload = () => { 
  displayEntries();
  updateConnectionStatus();
};

// Rejestracja Service Worker dla PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('Service Worker zarejestrowany:', registration);
      })
      .catch(error => {
        console.log('B≈ÇƒÖd rejestracji Service Worker:', error);
      });
  });
}

// Obs≈Çuga instalacji PWA
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');
const installButton = document.getElementById('installButton');
const dismissButton = document.getElementById('dismissButton');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installPrompt.style.display = 'block';
});

installButton.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`Wyb√≥r u≈ºytkownika: ${outcome}`);
    deferredPrompt = null;
    installPrompt.style.display = 'none';
  }
});

dismissButton.addEventListener('click', () => {
  installPrompt.style.display = 'none';
});

window.addEventListener('appinstalled', () => {
  installPrompt.style.display = 'none';
  console.log('PWA zosta≈Ça zainstalowana');
});
</script>
</body>
</html>
